<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Critical viewport meta tag for responsive design -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Skin Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .result-line {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @keyframes progress-bar-indeterminate {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .progress-bar-inner {
            width: 50%;
            animation: progress-bar-indeterminate 2s ease-in-out infinite;
        }
        /* Custom styles for modal transition */
        #consultationModal.opacity-0 {
            pointer-events: none;
        }
        #modalContent.scale-95 {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 flex items-center justify-center min-h-screen p-4">

    <!-- Main container: w-full for full width on small screens, max-w-2xl to limit width on desktop -->
    <div class="w-full max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-2xl shadow-2xl overflow-hidden">
        <!-- Header: Using sm: and md: prefixes to adjust padding and font size on different screens -->
        <div class="p-6 sm:p-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-900 dark:text-white">
                AI Skin Analysis
            </h1>
            <p class="text-center text-sm sm:text-base text-gray-500 dark:text-gray-400 mt-2">
                Please upload a clear facial photo to start your skin discovery journey.
            </p>
        </div>
        
        <div id="uploadContainer" class="p-6 sm:p-8 border-t border-gray-200 dark:border-gray-700">
            <!-- Upload Area: Adjusted padding for small screens -->
            <div id="uploadArea" class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl p-6 sm:p-8 text-center cursor-pointer hover:border-blue-500 dark:hover:border-blue-400 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-all">
                <input type="file" id="fileInput" class="hidden" accept="image/*">
                <div class="flex flex-col items-center">
                    <svg class="w-12 h-12 text-gray-400 dark:text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                    </svg>
                    <p class="mt-4 text-base sm:text-lg font-semibold text-gray-700 dark:text-gray-300">Click here to upload an image</p>
                    <p class="mt-1 text-xs sm:text-sm text-gray-500 dark:text-gray-400">Supports JPG, PNG, WEBP, etc.</p>
                </div>
            </div>

            <!-- Image Preview: Adjusted image size and used object-cover to maintain aspect ratio -->
            <div id="imagePreviewContainer" class="hidden mt-6 text-center">
                <img id="imagePreview" src="#" alt="Image Preview" class="w-48 h-48 sm:w-56 sm:h-56 object-cover mx-auto rounded-lg shadow-md"/>
            </div>

            <!-- Progress Bar -->
            <div id="progressContainer" class="hidden mt-8">
                <p id="progressText" class="text-center text-blue-600 dark:text-blue-400 font-medium mb-2 text-sm sm:text-base">Uploading and analyzing your skin...</p>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 overflow-hidden">
                    <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full progress-bar-inner"></div>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div id="resultsContainer" class="hidden p-6 sm:p-8 border-t border-gray-200 dark:border-gray-700">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white mb-4">
                üîç Skin Analysis Report
            </h2>
            <div id="results" class="space-y-3">
                <!-- Analysis results will be appended here -->
            </div>
            <button id="consultationButton" class="w-full mt-8 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center text-base sm:text-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 18h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
                Free Consultation
            </button>
        </div>
    </div>

    <!-- Consultation Modal: Using fixed positioning and w-full max-w-sm to adapt to mobile -->
    <div id="consultationModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 opacity-0 transition-opacity duration-300 hidden">
        <div id="modalContent" class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm p-6 relative transform scale-95 transition-transform duration-300">
            <!-- Close Button -->
            <button id="closeModalButton" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>

            <!-- Modal Header -->
            <p class="text-center text-gray-600 dark:text-gray-300 mb-8 mt-4 font-medium text-sm sm:text-base">
                Select a contact method to connect with a skincare advisor and get a more professional skin analysis report.
            </p>

            <!-- Contact Buttons -->
            <div class="space-y-4">
                <a href="http://wa.me/17062842721" target="_blank" rel="noopener noreferrer" class="flex items-center justify-center w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                    <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 24 24"><path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.59 15.36 3.45 16.86L2.05 22L7.31 20.62C8.75 21.41 10.36 21.82 12.04 21.82C17.5 21.82 21.95 17.37 21.95 11.91C21.95 9.27 20.92 6.83 19.17 4.99C17.42 3.14 14.87 2 12.04 2M12.04 3.67C14.25 3.67 16.31 4.5 17.87 6.05C19.42 7.6 20.28 9.66 20.28 11.91C20.28 16.47 16.65 20.1 12.04 20.1C10.56 20.1 9.14 19.73 7.91 19.05L7.5 18.83L4.43 19.65L5.28 16.7L5.04 16.27C4.31 15.05 3.8 13.53 3.8 11.91C3.8 7.35 7.43 3.67 12.04 3.67M9.13 7.5C8.91 7.5 8.7 7.72 8.7 8C8.7 8.28 8.91 8.5 9.13 8.5H9.17C9.39 8.5 9.6 8.28 9.6 8C9.6 7.72 9.39 7.5 9.17 7.5H9.13M14.93 7.5C14.71 7.5 14.5 7.72 14.5 8C14.5 8.28 14.71 8.5 14.93 8.5H14.97C15.19 8.5 15.4 8.28 15.4 8C15.4 7.72 15.19 7.5 14.97 7.5H14.93M16.93 13.25C16.85 13.03 16.38 12.8 16.16 12.72C15.94 12.63 15.78 12.59 15.61 12.85C15.45 13.12 14.98 13.7 14.82 13.86C14.66 14.02 14.5 14.06 14.23 13.94C13.95 13.82 12.98 13.48 11.82 12.45C10.91 11.64 10.32 10.73 10.16 10.46C10 10.18 10.13 10.04 10.25 9.92C10.36 9.8 10.5 9.64 10.63 9.5C10.75 9.36 10.8 9.24 10.9 9.06C11 8.88 10.94 8.72 10.86 8.58C10.78 8.44 10.25 7.18 10.03 6.65C9.82 6.12 9.6 6.18 9.44 6.17C9.28 6.16 9.08 6.16 8.88 6.16C8.68 6.16 8.4 6.24 8.16 6.48C7.92 6.72 7.3 7.25 7.3 8.3C7.3 9.35 8.18 10.35 8.32 10.53C8.46 10.71 10.03 13.01 12.35 13.93C14.68 14.84 14.68 14.53 15.21 14.49C15.74 14.45 16.65 13.89 16.81 13.31C16.97 12.73 16.97 12.24 16.93 12.12C16.93 13.25 16.93 13.25 16.93 13.25Z"/></svg>
                    WhatsApp
                </a>
                <a href="https://www.facebook.com/Drjane2?mibextid=wwXIfr" target="_blank" rel="noopener noreferrer" class="flex items-center justify-center w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                   <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 24 24"><path d="M14 13.5H16.5L17.5 9.5H14V7.5C14 6.47 14 5.5 16 5.5H17.5V2.14C17.174 2.097 15.943 2 14.643 2C11.928 2 10 3.657 10 6.7V9.5H7V13.5H10V22H14V13.5Z"/></svg>
                    FaceBook
                </a>
                 <a href="https://Drjane2.t.me" target="_blank" rel="noopener noreferrer" class="flex items-center justify-center w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                    <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 24 24"><path d="M9.78,18.65l.28,4.18a.5.5,0,0,0,.67.4,1.26,1.26,0,0,0,.52-.2l2.83-2.73,5.4,3.87a1,1,0,0,0,1.54-.92l3.22-15.48a1,1,0,0,0-1.3-1.15L1.23,10.62a1,1,0,0,0,.09,1.82Z"/></svg>
                    Telegram
                </a>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const uploadContainer = document.getElementById('uploadContainer');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const progressContainer = document.getElementById('progressContainer');
        const progressText = document.getElementById('progressText');
        const resultsContainer = document.getElementById('resultsContainer');
        const results = document.getElementById('results');
        
        // --- Modal Elements ---
        const consultationButton = document.getElementById('consultationButton');
        const consultationModal = document.getElementById('consultationModal');
        const modalContent = document.getElementById('modalContent');
        const closeModalButton = document.getElementById('closeModalButton');


        // --- Event Listeners ---
        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);

        // --- Modal Listeners ---
        consultationButton.addEventListener('click', showModal);
        closeModalButton.addEventListener('click', hideModal);
        
        // --- Functions ---
        
        function showModal() {
            consultationModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
            // Trigger animation
            setTimeout(() => {
                consultationModal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10); // A tiny delay ensures the transition works
        }

        function hideModal() {
            document.body.style.overflow = ''; // Restore scrolling
            // Trigger closing animation
            consultationModal.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            // Wait for animation to finish before hiding the element
            setTimeout(() => {
                consultationModal.classList.add('hidden');
            }, 300); // This should match the transition duration
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                // Show preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                };
                reader.readAsDataURL(file);
                
                imagePreviewContainer.classList.remove('hidden');
                uploadArea.classList.add('hidden');
                startAnalysis(file); // Pass the original file object
            } else if (file) {
                alert('Please select a valid image file.');
            }
        }

        async function startAnalysis(imageFile) {
            progressContainer.classList.remove('hidden');
            
            // --- Set initial analyzing state (red text with emoji) ---
            progressText.innerHTML = 'üîé Analyzing...';
            progressText.className = 'text-center text-red-600 dark:text-red-500 font-medium mb-2 text-sm sm:text-base';

            // Default 10 detection types sum (1+2+4+8+256+1024+8192+32768+65536+131072)
            const defaultDetectTypes = 238863;

            // Use relative path for production deployment
            const BACKEND_API_URL = 'http://154.37.222.128:3001'; 
            
            // --- Create FormData ---
            const formData = new FormData();
            formData.append('image', imageFile); // 'image' must match the field name set in backend multer
            formData.append('detectTypes', defaultDetectTypes);

            try {
                const response = await fetch(BACKEND_API_URL, {
                    method: 'POST',
                    body: formData, // Send the formData object directly
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.details || data.error || `Server responded with error: ${response.status}`);
                }

                if (data.code === 0) {
                    // --- Set success state (green text) ---
                    progressText.textContent = '‚úÖ Analysis complete! Generating report...';
                    progressText.className = 'text-center text-green-600 dark:text-green-500 font-medium mb-2 text-sm sm:text-base';
                    setTimeout(() => {
                        uploadContainer.classList.add('hidden');
                        resultsContainer.classList.remove('hidden');
                        displayResults(data);
                    }, 1000);
                } else {
                    throw new Error(data.msg || `API returned a business error (code: ${data.code})`);
                }

            } catch (error) {
                console.error('Analysis failed:', error);
                // --- Set error state (red text) ---
                progressText.innerHTML = `‚ùå Analysis Failed: <br>${error.message}`;
                progressText.className = 'text-center text-red-600 dark:text-red-500 font-medium mb-2 text-sm sm:text-base';
            }
        }

        function displayResults(data) {
            results.innerHTML = ''; // Clear old results
            let animationDelay = 0;

            // Translation mapping
            const translations = {
                // Levels
                severe: 'Severe', moderately: 'Moderate', lightly: 'Light', none: 'None',
                // Spot Categories
                B_QTB: 'Other Spots', Z_Z: 'Mole', B_QB: 'Freckle', B_HHB: 'Chloasma',
                // Pore/Skin Type Regions
                forehead: 'Forehead', left_cheek: 'Left Cheek', right_cheek: 'Right Cheek', chin: 'Chin', nose: 'Nose',
                // Skin Types
                mix: 'Mixed', oil: 'Oily', dry: 'Dry', mid: 'Normal', mid_oil: 'Normal to Oily', mid_dry: 'Normal to Dry',
                // Wrinkle Types
                glabella: 'Glabella Lines', crowfeet: 'Crow\'s Feet', nasolabial: 'Nasolabial Folds', eyecorner: 'Eye Corner Lines',
                // Pockmark Categories
                CC_DD: 'Acne', CC_DY: 'Acne Marks',
                // Dark Circle Types
                HHX: 'Mixed-type', SSX: 'Pigment-type', XGX: 'Vascular-type', YYX: 'Shadow-type', NONE: 'None',
                // Skin Colors
                toubai: 'Translucent White', baixi: 'Fair', ziran: 'Natural', xiaomai: 'Wheat', anchen: 'Dull', youhei: 'Dark'
            };

            const t = (key) => translations[key] || key;

            // --- Helper Functions ---
            const createSectionTitle = (title) => {
                const h3 = document.createElement('h3');
                h3.className = 'text-lg font-semibold text-gray-800 dark:text-gray-100 mt-6 border-b pb-2 mb-3';
                h3.textContent = title;
                results.appendChild(h3);
            };

            const createLine = (label, value, parent = results) => {
                if (value === undefined || value === null || value === '') return;
                const line = document.createElement('div');
                line.className = 'result-line bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg flex items-center justify-between text-sm';
                line.style.animationDelay = `${animationDelay}ms`;
                animationDelay += 50;
                line.innerHTML = `
                    <p class="font-medium text-gray-700 dark:text-gray-300">${label}</p>
                    <p class="font-semibold text-blue-600 dark:text-blue-400 text-right">${String(value)}</p>`;
                parent.appendChild(line);
            };
            
            const createDetailContainer = (parent = results) => {
                const container = document.createElement('div');
                container.className = 'pl-4 mt-2 space-y-2 border-l-2 border-gray-200 dark:border-gray-600 ml-2';
                parent.appendChild(container);
                return container;
            };
            
            // --- Start Rendering Results ---

            // 1. Skin Age (age)
            if (data.age) {
                createSectionTitle('1. Skin Age');
                createLine('Skin Age', `${data.age.result} years old`);
            }

            // 2. Spot Analysis (spot)
            if (data.spot) {
                createSectionTitle('2. Spot Analysis');
                createLine('Spot Count', data.spot.count);
                createLine('Spot Score', data.spot.score);
                createLine('Severity', t(data.spot.level));
                if (data.spot.category && data.spot.category.length > 0) {
                    const container = createDetailContainer();
                    data.spot.category.forEach(cat => {
                        createLine(`${t(cat.cls)} (${cat.count})`, `Score: ${cat.score} (${t(cat.level)})`, container);
                    });
                }
            }
            
            // 3. Pore Analysis (pore)
            if (data.pore) {
                createSectionTitle('3. Pore Analysis');
                createLine('Pore Count', data.pore.count);
                createLine('Pore Score', data.pore.score);
                createLine('Pore Area Ratio', `${(data.pore.area * 100).toFixed(2)}%`);
                if (data.pore.level) createLine('Severity', t(data.pore.level));
            }

            // 4. Skin Type (skin_type)
            if (data.skin_type) {
                createSectionTitle('4. Skin Type Analysis');
                createLine('Overall Skin Type', t(data.skin_type.type));
                createLine('Oiliness Level', data.skin_type.score);
                createLine('Condition Score', data.skin_type.level_score);
                if (data.skin_type.category && data.skin_type.category.length > 0) {
                    const container = createDetailContainer();
                    data.skin_type.category.forEach(cat => {
                        createLine(`${t(cat.cls)}: ${t(cat.type)}`, `Score: ${cat.score} (${t(cat.level)})`, container);
                    });
                }
            }

            // 5. Skin Color (color)
            if (data.color) {
                createSectionTitle('5. Skin Color Analysis');
                const colorMap = {
                    'toubai': '#f9e5d9', 'baixi': '#f2d5c3', 'ziran': '#efc2a7',
                    'xiaomai': '#c19b88', 'anchen': '#99715f', 'youhei': '#684a42'
                };
                const colorHex = colorMap[data.color.result] || '#ccc';
                const line = document.createElement('div');
                line.className = 'result-line bg-gray-50 dark:bg-gray-700/50 p-3 rounded-lg flex items-center justify-between text-sm';
                line.style.animationDelay = `${animationDelay}ms`;
                animationDelay += 50;
                line.innerHTML = `
                    <p class="font-medium text-gray-700 dark:text-gray-300">Skin Color Result</p>
                    <div class="flex items-center">
                        <span class="w-5 h-5 rounded-full mr-2 border border-gray-300" style="background-color: ${colorHex};"></span>
                        <p class="font-semibold text-blue-600 dark:text-blue-400">${t(data.color.result)}</p>
                    </div>`;
                results.appendChild(line);
            }

            // 6. Texture Analysis (texture)
            if (data.texture) {
                createSectionTitle('6. Texture Analysis');
                createLine('Texture Score', data.texture.score);
            }

            // 7. Wrinkle Analysis (wrinkle)
            if (data.wrinkle) {
                createSectionTitle('7. Wrinkle Analysis');
                createLine('Wrinkle Count', data.wrinkle.count);
                createLine('Wrinkle Score', data.wrinkle.score);
                createLine('Severity', t(data.wrinkle.level));
                if (data.wrinkle.category && data.wrinkle.category.length > 0) {
                    const container = createDetailContainer();
                    data.wrinkle.category.forEach(cat => {
                        if (cat.count > 0) {
                            createLine(`${t(cat.cls)} (${cat.count})`, `Score: ${cat.score} (${t(cat.level)})`, container);
                        }
                    });
                }
            }

            // 8. Blackhead Analysis (blackhead)
            if (data.blackhead) {
                createSectionTitle('8. Blackhead Analysis');
                createLine('Blackhead Count', data.blackhead.count);
                createLine('Blackhead Score', data.blackhead.score);
                createLine('Blackhead Area Ratio', `${(data.blackhead.area * 100).toFixed(2)}%`);
                createLine('Severity', t(data.blackhead.level));
            }

            // 9. Acne/Pockmark Analysis (pockmark)
            if (data.pockmark) {
                createSectionTitle('9. Acne/Pockmark Analysis');
                createLine('Total Count', data.pockmark.count);
                createLine('Overall Score', data.pockmark.score);
                createLine('Severity', t(data.pockmark.level));
                if (data.pockmark.category && data.pockmark.category.length > 0) {
                    const container = createDetailContainer();
                    data.pockmark.category.forEach(cat => {
                        createLine(`${t(cat.cls)} (${cat.count})`, `Score: ${cat.score}`, container);
                    });
                }
            }

            // 10. Dark Circle Analysis (dark_circle)
            if (data.dark_circle) {
                createSectionTitle('10. Dark Circle Analysis');
                createLine('Dark Circle Type', t(data.dark_circle.type));
                createLine('Severity', t(data.dark_circle.level));
                createLine('Dark Circle Score', data.dark_circle.score);
            }

            // Fallback message if no data was displayed
            if (results.innerHTML === '') {
                results.innerHTML = `<p class="text-center text-gray-500">No displayable analysis results were obtained from the API.</p>`;
            }
        }

        function resetState() {
            fileInput.value = '';
            resultsContainer.classList.add('hidden');
            imagePreviewContainer.classList.add('hidden');
            progressContainer.classList.add('hidden');
            uploadContainer.classList.remove('hidden');
            uploadArea.classList.remove('hidden');
            progressText.innerHTML = 'Uploading and analyzing your skin...';
            // Reset color back to default blue
            progressText.className = 'text-center text-blue-600 dark:text-blue-400 font-medium mb-2 text-sm sm:text-base';
        }
    </script>

</body>
</html>
